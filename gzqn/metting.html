<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>广州青年</title>
    <link rel="stylesheet" href="css/common/idangerous.swiper.css">
    <link rel="stylesheet" href="css/common/common.css">
    <link rel="stylesheet" href="css/index.css">
    <script src="js/common/jquery-1.8.3.js"></script>
    <script src="../js/common/common.js"></script>
    <script src="js/common/idangerous.swiper.min.js"></script>
    <script src="js/index.js"></script>
</head>
<body>
    <div id="header">
        <div class="header-wrapper">
            <div class="logo">
                <img src="../images/common/logo.jpg" alt="">
            </div>
            <div class="nav">
                <ul>
                    <li><a target="_blank" href="../index.html">首页</a></li>
                    <li><a target="_blank" href="../volunteer.html">志愿时</a></li>
                    <li><a target="_blank" href="../youth.html">青创汇</a></li>
                    <li><a target="_blank" href="../activity.html">U友缘</a></li>
                    <li class="active"><a href="index.html">广州青年</a></li>
                    <li><a target="_blank" href="#">团务系统</a></li>
                    <li style="margin-right:0px;"><a target="_blank" href="#">论坛</a></li>
                </ul>
            </div>
            <div class="header-r">
                <a href="javascript:;">
                    <img src="../images/common/sina.jpg" alt="">
                </a>
                <a href="javascript:;">
                    <img src="../images/common/wechat.jpg" alt="">
                </a>
                <a href="javascript:;">
                    <img src="../images/common/user.jpg" alt="">
                </a>
            </div>
        </div>
        <div class="sub_nav">
            <div class="subnav_wrapper">
                <ul>
                    <li class="active"><a href="#">广州青年首页</a></li>
                    <li><a href="#">不忘初心 牢记使命</a></li>
                    <li><a href="#">粤港澳大湾区</a></li>
                    <li><a href="#">穗团要闻</a></li>
                    <li><a href="#">公告栏</a></li>
                    <li><a href="#">基层快讯</a></li>
                    <li><a href="#">直属单位快讯</a></li>
                    <li><a href="#">文件资料</a></li>
                    <li><a href="#">志愿时</a></li>
                    <li style="margin-right:0px;"><a href="#">关于我们</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="metting-main">
        <div class="main-wrapper">
            <div class="title">
                <h3>我的会议通知</h3>
            </div>
            <div class="metting-list">
                 <ul>
                    <!--<li>
                        <a href="#">团知识分享会</a>
                        <div class="msg-box">
                            <span><p>会议时间：<em>2019-06-18  15:14:49</em></p></span>
                            <span><p>会议时间：<em>2019-06-18  15:14:49</em></p></span>
                            <span style="margin-right:0px;"><p>会议时间：<em>2019-06-18  15:14:49</em></p></span>
                            <button class="btn1">报名</button>
                            <button class="btn2" onclick="askForLeave()">告假</button>
                        </div>
                    </li>
                    <li>
                        <a href="#">团知识分享会</a>
                        <div class="msg-box">
                            <span><p>会议时间：<em>2019-06-18  15:14:49</em></p></span>
                            <span><p>会议时间：<em>2019-06-18  15:14:49</em></p></span>
                            <span style="margin-right:0px;"><p>会议时间：<em>2019-06-18  15:14:49</em></p></span>
                            <button class="btn1">取消报名</button>
                            <button class="btn2" onclick="askForLeave()">告假</button>
                        </div>
                    </li>
                    <li>
                        <a href="#">团知识分享会</a>
                        <div class="msg-box">
                            <span><p>会议时间：<em>2019-06-18  15:14:49</em></p></span>
                            <span><p>会议时间：<em>2019-06-18  15:14:49</em></p></span>
                            <span style="margin-right:0px;"><p>会议时间：<em>2019-06-18  15:14:49</em></p></span>
                            <button class="btn3">已截止</button>
                            <button class="btn4">已告假</button>
                        </div>
                    </li>
                    <li>
                        <a href="#">团知识分享会</a>
                        <div class="msg-box">
                            <span><p>会议时间：<em>2019-06-18  15:14:49</em></p></span>
                            <span><p>会议时间：<em>2019-06-18  15:14:49</em></p></span>
                            <span style="margin-right:0px;"><p>会议时间：<em>2019-06-18  15:14:49</em></p></span>
                            <button class="btn1">报名</button>
                            <button class="btn2" onclick="askForLeave()">告假</button>
                        </div>
                    </li>
                    <li>
                        <a href="#">团知识分享会</a>
                        <div class="msg-box">
                            <span><p>会议时间：<em>2019-06-18  15:14:49</em></p></span>
                            <span><p>会议时间：<em>2019-06-18  15:14:49</em></p></span>
                            <span style="margin-right:0px;"><p>会议时间：<em>2019-06-18  15:14:49</em></p></span>
                            <button class="btn3">已截止</button>
                        </div>
                    </li>
                    <li>
                        <a href="#">团知识分享会</a>
                        <div class="msg-box">
                            <span><p>会议时间：<em>2019-06-18  15:14:49</em></p></span>
                            <span><p>会议时间：<em>2019-06-18  15:14:49</em></p></span>
                            <span style="margin-right:0px;"><p>会议时间：<em>2019-06-18  15:14:49</em></p></span>
                            <button class="btn3">已截止</button>
                        </div>
                    </li> -->
                </ul>
            </div>            
            <h5 class="noDataShow" style="text-align: center;display: none;">暂无数据</h5>
            <div id="errorDiv" style="color:#d16e6c;text-align: center;"></div>
            <div class="pagination-wrap flex-row flex-center ">
                <div id="pagination"></div>
                <span class="current-page">第 <span> 1 </span> 页</span>
                <span class="total-page">共 <span> 1 </span> 页</span>
                <span class="total-num">共 <span> 1 </span> 条</span>
            </div>
        </div>
    </div>
    <div id="footer">
        <div class="foot-box">
            <div class="b-nav">
                <ul>
                    <li><a href="#">关于我们</a><span>|</span></li>
                    <li><a href="#">站内地图</a><span>|</span></li>
                    <li><a href="#">网址导航</a><span>|</span></li>
                    <li><a href="#">网站声明</a><span>|</span></li>
                    <li><a href="#">使用帮助</a></li>
                </ul>
            </div>
            <p>版权所有：共青团广州市委员会网站备案号：粤ICP备11043362号-2</p>
            <p>地址:广州市人民北路875号4-5楼   邮编:510170  E-mail:1234556@163.com</p>
        </div> 
    </div> 
</body>
<style>
    .pagination-wrap>span {
        color: #666;
        margin-left: 12px;
    }
	.clearfix:after {
	  visibility: hidden;
	  display: block;
	  font-size: 0;
	  content: " ";
	  clear: both;
	  height: 0;
	}
    .textFit{
        width: 100%;
        overflow: hidden;
        display: block;
        text-overflow: ellipsis;
        height:20px;
        white-space: nowrap;
    }
    .pagination  li{
        float: left;
        margin: 0 3px;
    }
    .pagination  li a {
        border-radius: 3px;
        overflow: hidden;
    }
    .jump-page {
        width: 52px;
        height: 30px;
        padding: 0 10px;
        border: 1px solid #ddd;
        border-radius: 3px;
        color: #717171;
    }
    .flex-row {
        display: flex;
        flex-direction: row;
    }
    .flex-col {
        display: flex;
        flex-direction: column;
    }
    .flex-top {
        align-items: flex-start;
    }
    .flex-bottom {
        align-items: flex-end;
    }
    .flex-left {
        justify-content: flex-start;
    }
    .flex-right {
        justify-content: flex-end;
    }
    .flex-ac {
        align-items: center;
    }
    .flex-jc {
        justify-content: center;
    }
    .flex-jsb {
        justify-content: space-between;
    }
    .flex-center {
        align-items: center;
        justify-content: center;
    }
    .msg-box>.disabled{
        background-color: #ccc !important;
    }
</style>
<script>
    $(function(){        
        var userInfo = getUserInfo();
        var meetingApi = {
            // list:APIGATEWAY + '/hdgl/meetingNotic/listdata',
            list:APIGATEWAY + '/hdgl/meetingNotic/listMeetingInfo',
            joinInsert:APIGATEWAY + '/hdgl/meetingJoinMan/baomingUpdate',
            cancel:APIGATEWAY + '/hdgl/meetingJoinMan/quxiaoUpdate',
            update:APIGATEWAY + '/hdgl/meetingJoinMan/delete',
        }
        loadMeetings(1)

        function loadMeetings(pageNum){
            var params = {//TODO加上文章ID
                phoneNum:userInfo.personMobile,
                pageNum: pageNum,
                pageSize: 10,
                order: 'asc',
                // searchAndOr: 'and',
                // 'searchMap[status]':0,
			};
			$.ajax({
				url: meetingApi.list,
				type: 'get',
				//contentType: 'text/html;charset=UTF-8' 'application/x-www-form-urlencoded',
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true,
				data: params,
				success: function(result) {
                    // 2,3 都是已告假
                    if(result.code=="success"){
                        var listData = result.body.pageInfoVo.list;
                        var listHtml = '';          
                        var total = result.body.pageInfoVo.total;
                        $('.total-num>span').html(total);                            
                        $('.noDataShow').hide();
                        if(!listData.length){                          
                            $('.metting-list>ul').empty();
                            $('.noDataShow').show();
                            refreshPages(0,0);
                            return;
                        }
                        var now = new Date().getTime()
                        listData.forEach(function(item,index) {
                            var isDeadline = now > new Date(item.deadline).getTime();
                            var btnArr = [{
                                text:'报名',
                                disabled:false,
                            },{
                                text:'告假',
                                disabled:false,
                            }
                            ];
                            if(item.status ==1){
                                btnArr[0].disabled = false;
                                btnArr[0].text = '取消报名';
                                btnArr[1].disabled = true;
                                btnArr[1].text = '告假';
                            }
                            else if(item.status == 0){
                                btnArr[0].disabled = false;
                                btnArr[0].text = '报名';
                                btnArr[1].disabled = false;
                                btnArr[1].text = '告假';
                                // vacationText = '已告假'
                            }else if(item.status == 2 || item.status == 3){
                                btnArr[0].disabled = true;
                                btnArr[0].text = '取消报名';
                                btnArr[1].disabled = true;
                                btnArr[1].text = '告假';
                                // vacationText = '已告假'
                            }
                            
                            listHtml +=`<li id="${item.id}">
                                <a href="#" onclick="showMeeting('${item.id}')">${item.meetingName}</a>
                                <div class="msg-box">
                                    <span><p>会议时间：<em>${item.startTime}</em></p></span>
                                    <span><p>会议地点：<em class="oneLine" style="display:inline-block;width:120px;">${item.meetingAddress}</em></p></span>
                                    <span style="margin-right:0px;"><p>报名截止时间：<em>${item.deadline}</em></p></span>
                                    <button class="btn1 ${btnArr[0].disabled?'disabled':''}" >${isDeadline?'已截止':btnArr[0].text}</button>
                                    <button class="btn2 ${isDeadline?'hidden':''} ${btnArr[1].disabled?'disabled':''}">${btnArr[1].text}</button>
                                </div>
                            </li>`;
                        });
                        $('.metting-list>ul').html(listHtml);

                        $('.msg-box>.btn1').on('click',function(){
                            if($(this).hasClass('disabled')){
                                return
                            }             
                            if($(this).text() == '报名'){
                                insertPerson($(this).parents('li').attr('id'),$(this));      
                            }
                            else{
                                delPerson($(this).parents('li').attr('id'),$(this))
                            }
                        })
                        //onclick="askForLeave('${item.id}')"
                        $('.msg-box>.btn2').on('click',function(){
                            if(!$(this).hasClass('disabled')){
                                askForLeave($(this).parents('li').attr('id'))
                            }                            
                        })
                        refreshPages( Math.ceil(total/10),result.body.pageInfoVo.pageNum)
                    }
                    else{
                        $("#errorDiv").html(result.message);
                    }
				}
			});
        }
        function insertPerson(id,_this){
            $.ajax({
				url: meetingApi.joinInsert+"?phone="+userInfo.personMobile+"&meetingId="+id,
                type: 'put',
                contentType: 'application/json',
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true,
                success: function(result) {
                    _this.parents("li").find(".btn2").addClass("disabled");
                    _this.parents("li").find(".btn1").text("取消报名");
                    alert('报名成功！')
                }
            })
        }
        function delPerson(id,_this){
            console.log(userInfo)
            $.ajax({
				url: meetingApi.cancel+"?phone="+userInfo.personMobile+"&meetingId="+id,
                type: 'put',
                contentType: 'application/json',
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true,
                success: function(result) {
                    _this.parents("li").find(".btn2").removeClass("disabled");
                    _this.parents("li").find(".btn1").text("报名");
                    alert('取消报名成功！')
                   
                }
            })
        }
        function getPagination(totalPage, currentPage) {
                var paginationInfo = "<ul class=\"pagination\" >" +
                    "<li><a href=\"javascript:void(0);\" " +
                    " page-info="+ (currentPage - 1) +
                     ">«</a></li>";
    
                if (totalPage <= 10) {
                    for (var i = 1; i <= totalPage; i++) {
                        var active = i == currentPage ? "active" : ""
                        paginationInfo += "<li class=\"" + active + "\"><a href=\"javascript:void(0);\" " +
                            " page-info="+ i + ">" + i + "</a></li>";
                    }
                } else {
                    if (currentPage <= 3) {
    
                        for (var i = 1; i <= currentPage + 2; i++) {
                            var active = i == currentPage ? "active" : ""
                            paginationInfo += "<li class=\"" + active + "\"><a href=\"javascript:void(0);\" " +
                                " page-info="+ i + ">" + i + "</a></li>";
                        }
                        paginationInfo += "<li><a href=\"#\">...</a></li>";
                        paginationInfo += "<li><a href=\"javascript:void(0);\" " +
                            " page-info="+ totalPage + ">" + totalPage +
                            "</a></li>";
                    } else if (currentPage <= totalPage - 5) {
                        paginationInfo += "<li><a href=\"javascript:void(0);\" " +
                            " page-info="+ 1 + ">" + 1 + "</a></li>";
    
                        paginationInfo += "<li><a href=\"#\">...</a></li>";
                        for (var i = currentPage - 1; i <= currentPage + 2; i++) {
                            var active = i == currentPage ? "active" : "";
                            paginationInfo += "<li class=\"" + active + "\"><a href=\"javascript:void(0);\" " +
                                " page-info="+ i + ">" + i + "</a></li>";
                        }
                        paginationInfo += "<li><a href=\"#\">...</a></li>";
                        paginationInfo += "<li><a href=\"javascript:void(0);\" " +
                            " page-info="+ totalPage + ">" + totalPage +
                            "</a></li>";
                    } else {
                        paginationInfo += "<li><a href=\"javascript:void(0);\" " +
                            " page-info="+ 1 + ">" + 1 + "</a></li>";
                        paginationInfo += "<li><a href=\"#\">...</a></li>";
                        for (var i = currentPage - 1; i <= totalPage; i++) {
                            var active = i == currentPage ? "active" : ""
                            paginationInfo += "<li class=\"" + active + "\"><a href=\"javascript:void(0);\" " +
                                " page-info="+ i + ">" + i + "</a></li>";
                        }
                    }
                }
    
                paginationInfo += "<li><a href=\"javascript:void(0);\" " +
                    " page-info="+ (currentPage + 1) + ">»</a></li>";
    
                return paginationInfo;
            }
                
            function refreshPages(totalPage, currentPage) {
                if (currentPage < 1 || currentPage > totalPage) {
                    return;
                }                
                var paginationInfo = getPagination(totalPage, currentPage);
                $('#pagination').html(paginationInfo);
                
                $('.pagination>li').on('click',function(){
                    var page = $(this).find('a[page-info]').attr('page-info');
                    if(page&&page>0){
                        loadMeetings(page)
                    }
                });
            }    
    })
</script>
</html>